<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Details</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
      integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="card">
        <div class="card-header text-center"><h4 id="formHeading">Student
            Details<a
              href=""id="back-btn" class="btn btn-danger float-end"><i
                class="fa-solid fa-backward"></i>Back</a></h4></div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Student Name</th>
                <th scope="col">Email</th>
                <th scope="col">Password</th>
                <th scope="col">Department</th>
                <th scope="col">Total Grade</th>
              </tr>
            </thead>
            <tbody id="student-details-body">

            </tbody>
          </table>
        </div>
      </div>
      <br><br>
      <div class="card">
        <div class="card-header text-center"><h4 id="formHeading">Subject
            Details</h4></div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Subject Name</th>
                <th scope="col">Obtained Marks</th>
                <th scope="col">Total Marks</th>
                <th scope="col">Percentage</th>
                <th scope="col">Grade</th>

              </tr>
            </thead>
            <tbody id="subject-list-body">

            </tbody>

          </table>
          <hr>
        </div>
      </div>
      <br><br>
      <div class="card">
        <div class="card-header text-center"><h4 id="formHeading">Test List
            <button id="add-test-btn" class="btn btn-warning float-end">
            <i class="fa-solid fa-plus"></i>Add new</button>
          </h4></div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Test Topic</th>
                <th scope="col">Obtained Marks</th>
                <th scope="col">Total Marks</th>
                <th scope="col">Percentage</th>
                <th scope="col">Grade</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="test-list-body">

            </tbody>
          </table>
          <hr>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
      integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
      crossorigin="anonymous"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const studentIndex = urlParams.get('studentIndex');
  const subjectId = urlParams.get('subjectId');

  document.getElementById('back-btn').href = `/view-student?studentIndex=${studentIndex}`;
  document.getElementById('add-test-btn').addEventListener('click', () => {
    window.location.href = `/create-test?studentIndex=${studentIndex}&subjectId=${subjectId}`;
  });

  // Load student data
  fetch(`/students/${studentIndex}`).then(res => res.json()).then(student => {
    const row = `
      <tr>
        <td>${parseInt(studentIndex) + 1}</td>
        <td>${student.name}</td>
        <td>${student.email}</td>
        <td>${student.password}</td>
        <td>${student.department}</td>
        <td>${student.grade || 'N/A'}</td>
      </tr>`;
    document.getElementById('student-details-body').innerHTML = row;
  });

  // Load subject data
  fetch(`/subjects/${studentIndex}`).then(res => res.json()).then(subjects => {
    const subject = subjects.find(s => s.id === parseInt(subjectId));
    if (!subject) return;

    const row = `
      <tr>
        <td>1</td>
        <td>${subject.subName}</td>
        <td>${subject.obtainedMarks || 0}</td>
        <td>${subject.totalMarks || 0}</td>
        <td>${subject.percentage || 0}%</td>
        <td>${subject.grade || 'F'}</td>
      </tr>`;
    document.getElementById('subject-list-body').innerHTML = row;
  });

  // Load and render test list with inline edit
  fetch(`/tests/${subjectId}`).then(res => res.json()).then(tests => {
    const tbody = document.getElementById('test-list-body');
    tbody.innerHTML = '';

    if (!tests.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No tests found.</td></tr>`;
      return;
    }

    tests.forEach((test, i) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i + 1}</td>
        <td>
          <span class="test-topic">${test.testTopic}</span>
          <input type="text" class="form-control form-control-sm d-none topic-edit" value="${test.testTopic}">
        </td>
        <td>
          <span class="obt">${test.obtainedMarks}</span>
          <input type="number" class="form-control form-control-sm d-none obt-edit" value="${test.obtainedMarks}">
        </td>
        <td>
          <span class="total">${test.totalMarks}</span>
          <input type="number" class="form-control form-control-sm d-none total-edit" value="${test.totalMarks}">
        </td>
        <td>${test.percentage || 0}%</td>
        <td>${test.grade || 'F'}</td>
        <td>
          <button class="btn btn-sm btn-primary d-none save-btn" data-id="${test.id}"><i class="fa-solid fa-check"></i></button>
          <button class="btn btn-sm btn-success edit-btn" data-id="${test.id}"><i class="fa-solid fa-pen"></i></button>
          <button class="btn btn-sm btn-danger delete-btn" data-id="${test.id}"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      tbody.appendChild(row);
    });

    // Edit Button Logic
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const row = btn.closest('tr');
        row.querySelector('.test-topic').classList.add('d-none');
        row.querySelector('.topic-edit').classList.remove('d-none');
        row.querySelector('.obt').classList.add('d-none');
        row.querySelector('.obt-edit').classList.remove('d-none');
        row.querySelector('.total').classList.add('d-none');
        row.querySelector('.total-edit').classList.remove('d-none');
        btn.classList.add('d-none');
        row.querySelector('.save-btn').classList.remove('d-none');
      });
    });

    // Save Button Logic
    document.querySelectorAll('.save-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const row = btn.closest('tr');
        const id = parseInt(btn.getAttribute('data-id'));
        const topic = row.querySelector('.topic-edit').value.trim();
        const obtained = parseFloat(row.querySelector('.obt-edit').value);
        const total = parseFloat(row.querySelector('.total-edit').value);

        if (!topic || isNaN(obtained) || isNaN(total) || total <= 0 || obtained > total) {
          alert('Enter valid test topic, obtained and total marks.');
          return;
        }

        fetch(`/tests/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            testTopic: topic,
            obtainedMarks: obtained,
            totalMarks: total
          })
        })
        .then(res => res.json())
        .then(() => location.reload());
      });
    });

    // Delete Button Logic
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (confirm("Delete this test?")) {
          fetch(`/tests/${id}`, { method: 'DELETE' }).then(() => location.reload());
        }
      });
    });
  });
</script>

  </body>
</html>