<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Details</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
      integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="card">
        <div class="card-header text-center"><h4 id="formHeading">Student
            Details<a
              href="/" class="btn btn-danger float-end"><i
                class="fa-solid fa-backward"></i>Back</a></h4></div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Student Name</th>
                <th scope="col">Email</th>
                <th scope="col">Password</th>
                <th scope="col">Department</th>
                <th scope="col">Grade</th>
              </tr>
            </thead>
            <tbody id="student-details-body">

            </tbody>
          </table>
        </div>
      </div>
      <br><br>
      <div class="card">
        <div class="card-header text-center"><h4 id="formHeading">Subject List<a
              href="" class="btn btn-warning float-end" id="add-subject-btn"><i
                class="fa-solid fa-plus"></i>Add new</a></h4></div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Subject Name</th>
                <th scope="col">Obtained Marks</th>
                <th scope="col">Total Marks</th>
                <th scope="col">Percentage</th>
                <th scope="col">Grade</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="subject-list-body">

            </tbody>

          </table>
          <hr>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
      integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
      crossorigin="anonymous"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const studentIndex = urlParams.get('studentIndex');
  const studentUrl = `/students/${studentIndex}`;
  const subjectsUrl = `/subjects/${studentIndex}`;

  // Update 'Add New' button
  document.getElementById('add-subject-btn').href = `/create-subject?studentIndex=${studentIndex}`;

  // Fetch and render student
  fetch(studentUrl).then(res => res.json()).then(student => {
    const row = `
      <tr>
        <td>${parseInt(studentIndex) + 1}</td>
        <td>${student.name}</td>
        <td>${student.email}</td>
        <td>${student.password}</td>
        <td>${student.department}</td>
        <td>${student.grade || 'N/A'}</td>
      </tr>`;
    document.getElementById('student-details-body').innerHTML = row;
  });

  // Fetch and render subjects
  function loadSubjects() {
    fetch(subjectsUrl).then(res => res.json()).then(subjects => {
      const table = document.getElementById('subject-list-body');
      table.innerHTML = '';

      if (!subjects.length) {
        table.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No subjects found.</td></tr>`;
        return;
      }

      subjects.forEach((subj, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>
            <span class="sub-name">${subj.subName}</span>
            <input type="text" class="form-control d-none sub-edit" value="${subj.subName}">
          </td>
          <td>
            <span class="obt-marks">${subj.obtainedMarks}</span>
            <input type="number" class="form-control d-none obt-edit" value="${subj.obtainedMarks}">
          </td>
          <td>
            <span class="total-marks">${subj.totalMarks}</span>
            <input type="number" class="form-control d-none total-edit" value="${subj.totalMarks}">
          </td>
          <td>${subj.percentage}%</td>
          <td>${subj.grade}</td>
          <td>
            <button class="btn btn-sm btn-success me-2 edit-btn" data-id="${subj.id}"><i class="fa-solid fa-pen"></i></button>
            <button class="btn btn-sm btn-primary d-none save-btn me-2" data-id="${subj.id}"><i class="fa-solid fa-check"></i></button>
            <button class="btn btn-sm btn-danger me-2 delete-btn" data-id="${subj.id}"><i class="fa-solid fa-trash"></i></button>
            <button class="btn btn-sm btn-secondary view-btn" data-subject-id="${subj.id}"><i class="fa-solid fa-eye"></i></button>
          </td>
        `;
        table.appendChild(row);
      });

      attachHandlers();
    });
  }

  // Handle all events after rendering
  function attachHandlers() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        tr.querySelector('.sub-name').classList.add('d-none');
        tr.querySelector('.sub-edit').classList.remove('d-none');
        tr.querySelector('.obt-marks').classList.add('d-none');
        tr.querySelector('.obt-edit').classList.remove('d-none');
        tr.querySelector('.total-marks').classList.add('d-none');
        tr.querySelector('.total-edit').classList.remove('d-none');
        btn.classList.add('d-none');
        tr.querySelector('.save-btn').classList.remove('d-none');
      });
    });

    document.querySelectorAll('.save-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        const id = parseInt(btn.getAttribute('data-id'));

        const subName = tr.querySelector('.sub-edit').value.trim();
        const obtainedMarks = parseFloat(tr.querySelector('.obt-edit').value);
        const totalMarks = parseFloat(tr.querySelector('.total-edit').value);

        if (!subName || isNaN(obtainedMarks) || isNaN(totalMarks) || totalMarks <= 0) {
          alert("Valid subject name and numeric marks are required.");
          return;
        }

        fetch(`/subjects/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subName, obtainedMarks, totalMarks })
        })
        .then(res => res.json())
        .then(() => loadSubjects());
      });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.getAttribute('data-id'));
        if (confirm('Are you sure you want to delete this subject?')) {
          fetch(`/subjects/${id}`, { method: 'DELETE' })
            .then(() => loadSubjects());
        }
      });
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const subjectId = btn.getAttribute('data-subject-id');
        window.location.href = `/view-subject?studentIndex=${studentIndex}&subjectId=${subjectId}`;
      });
    });
  }
  // Load everything on page load
  loadSubjects();
</script>
  </body>
</html>